<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kalkulator Gaji - Final Complete</title>
<style>
  body { font-family: Arial, sans-serif; margin:20px; background:#f5f7fb; }
  .container { max-width:980px; margin:auto; background:white; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  h2 { text-align:center; margin:0 0 12px; }
  label { display:block; margin-top:10px; font-size:14px; color:#333; }
  input[type="text"], input[type="number"] { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; border:1px solid #ddd; border-radius:6px; }
  .result { margin-top:16px; font-size:14px; line-height:1.5; background:#fafafa; padding:12px; border-radius:8px; border:1px solid #eee; min-height:56px; }
  .legend { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
  .legend span { font-size:13px; padding:6px 10px; border-radius:6px; color:white; }
  .lg-hari{ background:#4caf50 } .lg-hari12{ background:#ff9800 } .lg-hari12malam{ background:#3f51b5 } .lg-lembur{ background:#1976d2 }
  .btn { display:block; width:100%; padding:10px; border-radius:8px; border:none; cursor:pointer; font-size:15px; margin-top:10px; }
  .download-btn { background:#1976d2; color:white; }
  .reset-btn { background:#efefef; color:#333; }
  .calendar-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:9999; }
  .calendar { background:white; padding:14px; border-radius:10px; width:720px; max-width:96%; box-shadow:0 8px 30px rgba(0,0,0,0.12); }
  .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .calendar-days { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .day-name { font-weight:700; text-align:center; font-size:13px; color:#444; padding:6px 0; }
  .day { padding:8px; text-align:center; border-radius:6px; cursor:pointer; user-select:none; border:1px solid transparent; min-height:36px; display:flex; align-items:center; justify-content:center; position:relative; }
  .day:hover { background:#f1f1f1; }
  .selected-hari { background:#4caf50; color:white; }
  .selected-hari12 { background:#ff9800; color:white; }
  .selected-hari12malam { background:#3f51b5; color:white; }
  .selected-lembur { background:#1976d2; color:white; }
  .holiday { color:#d32f2f; font-weight:700; }
  .disabled-day { background:#eee !important; color:#999 !important; cursor:not-allowed !important; text-decoration: line-through; }
  .reason { font-size:10px; position:absolute; bottom:2px; left:2px; right:2px; text-align:center; color:#666; }
  #holidayNotes { margin-top:8px; font-size:13px; color:#d32f2f; }
  #exportArea { display:none; padding:18px; background:white; width:880px; max-width:96%; margin:12px auto; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
  table.export-cal { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 13px; border-radius: 8px; overflow: hidden; }
  table.export-cal th { background: #1976d2; color: white; font-weight: 600; padding: 8px; text-align: center; }
  table.export-cal td { border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: middle; min-width: 36px; height: 42px; background: #fff; }
  table.export-cal td.holiday { background: #ffecec !important; color: #d32f2f !important; font-weight: bold; }
  @media print { .btn, input, .container { -webkit-print-color-adjust: exact; } }
</style>
</head>
<body>
  <div class="container" role="main">
    <h2>Kalkulator Gaji</h2>

    <label>Kerja 8 Jam (Rp80.000/hari)</label>
    <input type="text" id="hari" readonly placeholder="Klik untuk pilih di kalender">

    <label>Kerja Lembur 8 Jam (Rp101.000/hari)</label>
    <input type="text" id="lembur" readonly placeholder="Klik untuk pilih di kalender">

    <label>Kerja 12 Jam - Shift Pagi (Rp116.000/hari)</label>
    <input type="text" id="hari12" readonly placeholder="Klik untuk pilih di kalender">

    <label>Kerja 12 Jam - Shift Malam (Rp121.000/hari)</label>
    <input type="text" id="hari12Malam" readonly placeholder="Klik untuk pilih di kalender">

    <label>Jumlah Jam Lembur (Rp12.000/jam)</label>
    <input type="number" id="jam" value="0" min="0">

    <label style="margin-top:10px"><input type="checkbox" id="bonus"> &nbsp;Tidak ada sakit/izin (Uang Kerajinan Rp100.000)</label>

    <label>Bonus Mister (nominal)</label>
    <input type="text" id="bonusMister" placeholder="Masukkan nominal (angka saja)">

    <div class="result" id="rincian" aria-live="polite"></div>

    <div class="legend" aria-hidden="true">
      <span class="lg-hari">8 Jam</span>
      <span class="lg-hari12">12 Jam Pagi</span>
      <span class="lg-hari12malam">12 Jam Malam</span>
      <span class="lg-lembur">Lembur 8 Jam</span>
    </div>

    <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px;">
      <button class="btn download-btn" id="downloadBtn">📥 Unduh Slip (PDF)</button>
      <button class="btn download-btn" id="downloadPngBtn">📥 Unduh Slip (PNG)</button>
      <button class="btn download-btn" id="backupBtn">💾 Backup (.txt)</button>
      <button class="btn download-btn" id="restoreBtn">📤 Pulihkan (.txt)</button>
    </div>

    <input type="file" id="restoreFile" accept=".txt" style="display:none" />
    <button class="btn reset-btn" id="resetBtn">🔄 Reset</button>
  </div>

  <div id="exportArea" aria-hidden="true"></div>

  <div class="calendar-modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="calendar" role="document" aria-label="Kalender pemilihan tanggal">
      <div class="calendar-header">
        <button id="prev" aria-label="Bulan sebelumnya">&lt;</button>
        <strong id="monthYear" aria-live="polite"></strong>
        <button id="next" aria-label="Bulan berikutnya">&gt;</button>
      </div>
      <div class="calendar-days" id="calDays" aria-hidden="false"></div>
      <div id="holidayNotes" aria-live="polite"></div>
      <div style="text-align:right;margin-top:10px;">
        <button id="closeBtn" class="btn reset-btn" style="width:auto;padding:8px 12px">Batal</button>
        <button id="okBtn" class="btn" style="width:auto;padding:8px 12px;background:#4caf50;color:#fff">OK</button>
      </div>
    </div>
  </div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* --------------------
   All code in one file
   -------------------- */

/* State */
let selectedHari = new Set();          // kerja 8 jam
let selectedHari12 = new Set();        // kerja 12 jam pagi
let selectedHari12Malam = new Set();   // kerja 12 jam malam
let selectedLembur = new Set();        // lembur 8 jam
let holidays = {};                     // { 'YYYY-MM-DD': 'Name' }

let activeInput = null; // element (elHari, elHari12, elHari12Malam, elLembur) while modal open
let activeSet = null;
let calMonth = new Date().getMonth();
let calYear = new Date().getFullYear();

const dayNames = ['Sen','Sel','Rab','Kam','Jum','Sab','Min'];
const monthNames = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

const elHari = document.getElementById('hari');
const elHari12 = document.getElementById('hari12');
const elHari12Malam = document.getElementById('hari12Malam');
const elLembur = document.getElementById('lembur');
const elJam = document.getElementById('jam');
const elBonus = document.getElementById('bonus');
const elBonusMister = document.getElementById('bonusMister');
const rincian = document.getElementById('rincian');
const modal = document.getElementById('modal');
const calDays = document.getElementById('calDays');
const calTitle = document.getElementById('monthYear');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const okBtn = document.getElementById('okBtn');
const closeBtn = document.getElementById('closeBtn');
const resetBtn = document.getElementById('resetBtn');
const exportArea = document.getElementById('exportArea');
const restoreFile = document.getElementById('restoreFile');

/* --- Holidays loader (Google Calendar public) --- */
async function loadHolidaysFromGoogle(year = calYear, month = calMonth){
  const timeMin = new Date(year, month, 1).toISOString();
  const timeMax = new Date(year, month+1, 0, 23,59,59).toISOString();
  const key = 'AIzaSyDthcv4JRESSbShy9Zq3c0acFx8L_9HDp4';
  const url = 'https://www.googleapis.com/calendar/v3/calendars/id.indonesian%23holiday@group.v.calendar.google.com/events' +
              '?key=' + key +
              '&timeMin=' + encodeURIComponent(timeMin) +
              '&timeMax=' + encodeURIComponent(timeMax);
  try {
    const res = await fetch(url);
    const data = await res.json();
    holidays = {};
    if (data && data.items) {
      data.items.forEach(ev => {
        if (ev.start && ev.start.date) holidays[ev.start.date] = ev.summary || '';
      });
    }
  } catch (err) {
    // jika fetch gagal, biarkan holidays kosong (takut CORS / offline)
    console.warn('Gagal memuat libur nasional:', err);
    holidays = {};
  }
}

/* --- Build calendar --- */
async function buildCalendar(){
  await loadHolidaysFromGoogle(calYear, calMonth);
  calDays.innerHTML = '';
  calTitle.textContent = monthNames[calMonth] + ' ' + calYear;

  // day headers
  dayNames.forEach(d => {
    const h = document.createElement('div');
    h.className = 'day-name';
    h.textContent = d;
    calDays.appendChild(h);
  });

  const first = new Date(calYear, calMonth, 1);
  const last = new Date(calYear, calMonth+1, 0);
  // Monday-first column
  const start = (first.getDay() + 6) % 7;
  for (let i=0;i<start;i++) calDays.appendChild(document.createElement('div'));

  const holidayList = [];

  for (let d=1; d<=last.getDate(); d++){
    const div = document.createElement('div');
    div.className = 'day';
    div.textContent = d;
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayOfWeek = new Date(calYear, calMonth, d).getDay(); // 0=Sun,6=Sat
    const isHoliday = !!holidays[dateStr];

    // colorize by sets
    if (selectedHari.has(dateStr)) div.classList.add('selected-hari');
    if (selectedHari12.has(dateStr)) div.classList.add('selected-hari12');
    if (selectedHari12Malam.has(dateStr)) div.classList.add('selected-hari12malam');
    if (selectedLembur.has(dateStr)) div.classList.add('selected-lembur');
    if (isHoliday) {
      div.classList.add('holiday');
      holidayList.push(`${d} ${monthNames[calMonth]}: ${holidays[dateStr]}`);
    }

    // find owner if any
    let owner = null; // 'hari','hari12','hari12Malam','lembur' or null
    if (selectedHari.has(dateStr)) owner = 'hari';
    else if (selectedHari12.has(dateStr)) owner = 'hari12';
    else if (selectedHari12Malam.has(dateStr)) owner = 'hari12Malam';
    else if (selectedLembur.has(dateStr)) owner = 'lembur';

    // compute usedByOther only when modal is open
    let usedByOther = false;
    if (activeInput) {
      if (owner) {
        // if owner exists and activeInput is not that owner, then usedByOther = true
        if ( (owner === 'hari' && activeInput !== elHari) ||
             (owner === 'hari12' && activeInput !== elHari12) ||
             (owner === 'hari12Malam' && activeInput !== elHari12Malam) ||
             (owner === 'lembur' && activeInput !== elLembur) ) {
          usedByOther = true;
        }
      }
    }

    // compute markDisabled by rules (only when modal open and the date is not owned by active form)
    let markDisabled = false;
    if (activeInput) {
      // If the date is already owned by the active set, allow toggle (do not markDisabled)
      const ownedByActive = (owner === 'hari' && activeInput === elHari) ||
                            (owner === 'hari12' && activeInput === elHari12) ||
                            (owner === 'hari12Malam' && activeInput === elHari12Malam) ||
                            (owner === 'lembur' && activeInput === elLembur);

      if (!ownedByActive) {
        if (activeInput === elHari) {
          // Kerja 8 jam: only Mon-Fri and not holiday
          if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday) markDisabled = true;
        } else if (activeInput === elLembur) {
          // Lembur 8 jam: only Sat/Sun or holiday
          if (!isHoliday && !(dayOfWeek === 0 || dayOfWeek === 6)) markDisabled = true;
        }
        // 12h forms: no day restrictions
      }
    }

    // Decide final disabled state
    if (usedByOther || markDisabled) {
      div.classList.add('disabled-day');
      // add reason tooltip text inside small node for clarity
      const reason = document.createElement('div');
      reason.className = 'reason';
      if (usedByOther) {
        // show which form uses it
        let by = owner === 'hari' ? 'Kerja 8 Jam' : owner === 'hari12' ? '12 Jam Pagi' : owner === 'hari12Malam' ? '12 Jam Malam' : 'Lembur 8 Jam';
        reason.textContent = 'Dipakai: ' + by;
      } else if (markDisabled) {
        if (activeInput === elHari) reason.textContent = 'Bukan hari kerja (Sab/Ming/Libur)';
        else if (activeInput === elLembur) reason.textContent = 'Bukan hari lembur (Sen–Jum)';
        else reason.textContent = '';
      }
      if (reason.textContent) div.appendChild(reason);
      // no click handler
    } else {
      // attach click handler (toggle). This covers:
      // - free date; or
      // - owner date when active (so owner can unselect)
      div.addEventListener('click', () => {
        if (!activeSet) return;
        // final validation guard
        const isHoliday2 = !!holidays[dateStr];
        if (activeInput === elHari) {
          if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday2) return;
        } else if (activeInput === elLembur) {
          if (!isHoliday2 && !(dayOfWeek === 0 || dayOfWeek === 6)) return;
        }
        // toggle
        if (activeSet.has(dateStr)) activeSet.delete(dateStr);
        else activeSet.add(dateStr);
        saveCache();
        buildCalendar();
      });
    }

    calDays.appendChild(div);
  } // end for days

  // show holiday notes
  const notes = document.getElementById('holidayNotes');
  if (holidayList.length) {
    notes.innerHTML = "<b>Libur Nasional Bulan Ini:</b><ul style='margin:6px 0 0 18px;padding:0;'>" + holidayList.map(it => `<li>${it}</li>`).join('') + "</ul>";
  } else notes.innerHTML = '';
}

/* --- Hitung & tampilkan rincian --- */
function hitung(){
  const h = selectedHari.size;
  const h12 = selectedHari12.size;
  const h12M = selectedHari12Malam.size;
  const l = selectedLembur.size;
  const j = parseInt(elJam.value) || 0;
  const b = elBonus.checked ? 100000 : 0;
  const bonusM = parseInt(elBonusMister.value.replace(/\D/g,'')) || 0;

  const gajiHari = h * 80000;
  const gajiHari12 = h12 * 116000;
  const gajiHari12M = h12M * 121000;
  const gajiLembur = l * 101000;
  const gajiJam = j * 12000;
  const total = gajiHari + gajiHari12 + gajiHari12M + gajiLembur + gajiJam + b + bonusM;

  rincian.innerHTML = `
    <div>Kerja 8 Jam (${h} hari): Rp${gajiHari.toLocaleString('id-ID')}</div>
    <div>12 Jam Pagi (${h12} hari): Rp${gajiHari12.toLocaleString('id-ID')}</div>
    <div>12 Jam Malam (${h12M} hari): Rp${gajiHari12M.toLocaleString('id-ID')}</div>
    <div>Lembur 8 Jam (${l} hari): Rp${gajiLembur.toLocaleString('id-ID')}</div>
    <div>Lembur per jam (${j} jam): Rp${gajiJam.toLocaleString('id-ID')}</div>
    <div>Uang Kerajinan: Rp${b.toLocaleString('id-ID')}</div>
    <div>Bonus Mister: Rp${bonusM.toLocaleString('id-ID')}</div>
    <hr/>
    <div><strong>Total Gaji: Rp${total.toLocaleString('id-ID')}</strong></div>
  `;
}

/* --- Cache / Backup / Restore --- */
function getDataObj(){
  return {
    hari: [...selectedHari],
    hari12: [...selectedHari12],
    hari12Malam: [...selectedHari12Malam],
    lembur: [...selectedLembur],
    jam: elJam.value,
    bonus: elBonus.checked,
    bonusMister: elBonusMister.value
  };
}
function applyDataObj(d){
  selectedHari = new Set(d.hari || []);
  selectedHari12 = new Set(d.hari12 || []);
  selectedHari12Malam = new Set(d.hari12Malam || []);
  selectedLembur = new Set(d.lembur || []);
  elJam.value = d.jam || 0;
  elBonus.checked = !!d.bonus;
  elBonusMister.value = d.bonusMister || '';
  elHari.value = selectedHari.size ? (selectedHari.size + ' Hari') : '';
  elHari12.value = selectedHari12.size ? (selectedHari12.size + ' Hari') : '';
  elHari12Malam.value = selectedHari12Malam.size ? (selectedHari12Malam.size + ' Hari') : '';
  elLembur.value = selectedLembur.size ? (selectedLembur.size + ' Hari') : '';
  hitung();
  buildCalendar();
}
function saveCache(){ try { localStorage.setItem('gajiCache', JSON.stringify(getDataObj())); } catch(e){} }
function loadCache(){ try { const c = localStorage.getItem('gajiCache'); if (c) applyDataObj(JSON.parse(c)); } catch(e){} }

/* --- Export / render area --- */
function renderExportArea(){
  exportArea.style.display = 'block';
  exportArea.innerHTML = '';

  const title = document.createElement('h3');
  title.textContent = monthNames[calMonth] + ' ' + calYear;
  exportArea.appendChild(title);

  const table = document.createElement('table');
  table.className = 'export-cal';
  const header = document.createElement('tr');
  dayNames.forEach(d => {
    const th = document.createElement('th');
    th.textContent = d;
    header.appendChild(th);
  });
  table.appendChild(header);

  const first = new Date(calYear, calMonth, 1);
  const last = new Date(calYear, calMonth+1, 0);
  const start = (first.getDay() + 6) % 7;
  let row = document.createElement('tr');
  for (let i=0;i<start;i++) row.appendChild(document.createElement('td'));

  for (let d=1; d<=last.getDate(); d++){
    const td = document.createElement('td');
    td.textContent = d;
    td.style.minWidth = '32px';
    td.style.height = '40px';
    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (selectedHari.has(dateStr)) td.style.background = '#4caf50';
    if (selectedHari12.has(dateStr)) td.style.background = '#ff9800';
    if (selectedHari12Malam.has(dateStr)) td.style.background = '#3f51b5';
    if (selectedLembur.has(dateStr)) td.style.background = '#1976d2';
    if (holidays[dateStr]) { td.classList.add('holiday'); td.title = holidays[dateStr]; }
    row.appendChild(td);
    if ((start + d - 1) % 7 === 6) {
      table.appendChild(row);
      row = document.createElement('tr');
    }
  }
  if (row.children.length) table.appendChild(row);
  exportArea.appendChild(table);

  const holidayEntries = Object.entries(holidays);
  if (holidayEntries.length) {
    const notes = document.createElement('div');
    notes.style.marginTop = '10px';
    notes.innerHTML = '<b>Libur Nasional:</b><ul style="margin:6px 0 0 18px;padding:0;">' +
      holidayEntries.map(([date,name]) => {
        const dt = new Date(date);
        return `<li>${dt.getDate()} ${monthNames[dt.getMonth()]}: ${name}</li>`;
      }).join('') + '</ul>';
    exportArea.appendChild(notes);
  }

  const legend = document.createElement('div');
  legend.style.marginTop = '10px';
  legend.innerHTML = `
    <span style="background:#4caf50;color:white;padding:4px 8px;border-radius:4px;font-size:12px;">8 Jam</span>
    <span style="background:#ff9800;color:white;padding:4px 8px;border-radius:4px;font-size:12px;margin-left:8px;">12 Jam Pagi</span>
    <span style="background:#3f51b5;color:white;padding:4px 8px;border-radius:4px;font-size:12px;margin-left:8px;">12 Jam Malam</span>
    <span style="background:#1976d2;color:white;padding:4px 8px;border-radius:4px;font-size:12px;margin-left:8px;">Lembur</span>
  `;
  exportArea.appendChild(legend);

  const rincianCopy = document.createElement('div');
  rincianCopy.style.marginTop = '14px';
  rincianCopy.innerHTML = rincian.innerHTML;
  exportArea.appendChild(rincianCopy);
}

/* --- Buttons: backup / restore / download --- */
document.getElementById('backupBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(getDataObj(), null, 2)], { type: 'text/plain' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'backup-gaji.txt';
  link.click();
});

document.getElementById('restoreBtn').addEventListener('click', () => restoreFile.click());
restoreFile.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      applyDataObj(data);
      saveCache();
      alert('✅ Data berhasil dipulihkan');
    } catch (err) {
      alert('❌ File tidak valid');
    }
    restoreFile.value = '';
  };
  reader.readAsText(file);
});

document.getElementById('downloadPngBtn').addEventListener('click', () => {
  renderExportArea();
  const exp = exportArea;
  setTimeout(() => {
    html2canvas(exp, { scale: 2 }).then(canvas => {
      exp.style.display = 'none';
      const link = document.createElement('a');
      link.download = 'Slip-Gaji.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }).catch(err => {
      exp.style.display = 'none';
      console.error('html2canvas error:', err);
      alert('Gagal membuat PNG. Buka console untuk detail.');
    });
  }, 160);
});

document.getElementById('downloadBtn').addEventListener('click', () => {
  renderExportArea();
  const exp = exportArea;
  setTimeout(() => {
    html2canvas(exp, { scale: 2 }).then(canvas => {
      const { jsPDF } = window.jspdf;
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgWidth = pageWidth;
      const imgHeight = canvas.height * imgWidth / canvas.width;
      pdf.addImage(imgData, 'PNG', 0, 8, imgWidth, imgHeight);
      exp.style.display = 'none';
      pdf.save('Slip-Gaji.pdf');
    }).catch(err => {
      exp.style.display = 'none';
      console.error('html2canvas error:', err);
      alert('Gagal membuat PDF. Buka console untuk detail.');
    });
  }, 200);
});

/* --- Input events (open modal) --- */
[elHari, elHari12, elHari12Malam, elLembur].forEach(el => {
  el.addEventListener('click', () => {
    activeInput = el;
    activeSet = (el === elHari ? selectedHari : el === elHari12 ? selectedHari12 : el === elHari12Malam ? selectedHari12Malam : selectedLembur);
    // update summary input values
    elHari.value = selectedHari.size ? (selectedHari.size + ' Hari') : '';
    elHari12.value = selectedHari12.size ? (selectedHari12.size + ' Hari') : '';
    elHari12Malam.value = selectedHari12Malam.size ? (selectedHari12Malam.size + ' Hari') : '';
    elLembur.value = selectedLembur.size ? (selectedLembur.size + ' Hari') : '';
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    buildCalendar();
  });
});

/* OK / Close modal */
okBtn.addEventListener('click', () => {
  if (activeInput && activeSet) {
    activeInput.value = activeSet.size ? (activeSet.size + ' Hari') : '';
    hitung();
    saveCache();
  }
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
  activeInput = null;
  activeSet = null;
  // redraw calendar without activeInput so disabled marks are cleared
  buildCalendar();
});
closeBtn.addEventListener('click', () => {
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
  activeInput = null;
  activeSet = null;
  buildCalendar();
});

/* month nav */
prevBtn.addEventListener('click', () => { calMonth--; if (calMonth<0){calMonth=11;calYear--;} buildCalendar(); });
nextBtn.addEventListener('click', () => { calMonth++; if (calMonth>11){calMonth=0;calYear++;} buildCalendar(); });

/* other inputs */
elJam.addEventListener('input', () => { hitung(); saveCache(); });
elBonus.addEventListener('input', () => { hitung(); saveCache(); });
elBonusMister.addEventListener('input', () => { elBonusMister.value = elBonusMister.value.replace(/\D/g,''); hitung(); saveCache(); });

/* reset */
resetBtn.addEventListener('click', () => {
  if (!confirm('Reset semua data?')) return;
  selectedHari.clear(); selectedHari12.clear(); selectedHari12Malam.clear(); selectedLembur.clear();
  elHari.value = ''; elHari12.value = ''; elHari12Malam.value = ''; elLembur.value = '';
  elJam.value = 0; elBonus.checked = false; elBonusMister.value = '';
  rincian.innerHTML = '';
  try { localStorage.removeItem('gajiCache'); } catch(e){}
  buildCalendar();
  hitung();
});

/* init */
loadCache();
buildCalendar();
hitung();

</script>
</body>
</html>
